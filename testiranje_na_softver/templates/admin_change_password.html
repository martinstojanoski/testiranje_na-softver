{% extends "base.html" %}
{% block title %}Change Password{% endblock %}

{% block content %}
<style>
  :root{
    --bgA:#070708;
    --card: rgba(18,18,20,.66);
    --stroke: rgba(255,215,0,.18);
    --gold:#ffd700;
    --gold2:#c9a200;
    --text:#f2f2f2;
    --muted:#b9b9b9;
    --danger:#ff4d4d;
    --ok:#4dff8b;
  }

  body{
    background:
      radial-gradient(900px 520px at 18% 0%, rgba(255,215,0,.10), transparent 60%),
      radial-gradient(760px 460px at 82% 10%, rgba(187,134,252,.08), transparent 58%),
      radial-gradient(circle at top, #151516, #0b0b0c 55%, #060607);
    color: var(--text);
    font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
  }

  .wrap{
    padding: 70px 14px;
    min-height: calc(100vh - 160px);
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .card{
    width:100%;
    max-width: 560px;
    border-radius: 26px;
    background: var(--card);
    border: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 22px 55px rgba(0,0,0,.82);
    padding: 30px 26px;
    position: relative;
    overflow:hidden;
    animation: cardIn .55s ease both;
  }

  .card::before{
    content:"";
    position:absolute;
    inset: -120px auto auto -160px;
    width: 360px; height: 360px;
    background: radial-gradient(circle, rgba(255,215,0,.12), transparent 60%);
    pointer-events:none;
  }

  @keyframes cardIn{
    from{ opacity:0; transform: translateY(16px); }
    to{ opacity:1; transform: translateY(0); }
  }

  .top{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 12px;
    margin-bottom: 14px;
  }

  h2{ margin:0; color:#fff; font-size: 20px; letter-spacing:.5px; }
  .sub{ margin:8px 0 0; color: var(--muted); font-size: 13.5px; line-height: 1.45; }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border-radius:999px;
    background: rgba(255,255,255,.03);
    border:1px solid rgba(255,215,0,.12);
    color:#ddd;
    font-size: 12.5px;
    white-space:nowrap;
  }
  .pill b{ color:#fff; }

  /* Flash */
  .flash{
    padding: 12px;
    margin: 14px 0 0;
    border-radius: 14px;
    font-size: 14px;
    text-align:center;
    border-left: 4px solid transparent;
    background: rgba(255,255,255,.04);
  }
  .flash.success{ border-left-color: var(--ok); color:#d8ffe5; background: rgba(30,95,43,.35); }
  .flash.error{ border-left-color: var(--danger); color:#ffd0d0; background: rgba(59,29,29,.55); }

  .field{
    margin-top: 14px;
    text-align:left;
  }

  label{
    display:block;
    margin-bottom: 6px;
    font-weight: 900;
    color:#e8e8e8;
    font-size: 13px;
  }

  .control{
    position: relative;
  }

  input{
    width:100%;
    padding: 13px 46px 13px 14px;
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    background: rgba(0,0,0,.28);
    color:#fff;
    outline:none;
    transition:.22s;
    font-size: 14.5px;
  }

  input:focus{
    border-color: rgba(255,215,0,.55);
    box-shadow: 0 0 0 4px rgba(255,215,0,.10);
    background: rgba(0,0,0,.36);
  }

  .icon{
    position:absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    width: 34px; height: 34px;
    border-radius: 12px;
    border: 1px solid rgba(255,215,0,.18);
    background: rgba(255,215,0,.08);
    color: var(--gold);
    display:flex;
    align-items:center;
    justify-content:center;
    user-select:none;
    cursor:pointer;
    transition:.22s;
  }
  .icon:hover{
    background: rgba(255,215,0,.14);
  }

  /* Strength */
  .strength{ margin-top: 10px; }
  .strength-bar{
    height: 8px;
    border-radius: 999px;
    background: rgba(255,255,255,.08);
    overflow:hidden;
    border: 1px solid rgba(255,215,0,.10);
  }
  .strength-bar > div{
    height:100%;
    width:0%;
    transition: .25s;
  }
  .weak{ background: linear-gradient(90deg, rgba(255,77,77,.95), rgba(255,77,77,.35)); }
  .medium{ background: linear-gradient(90deg, rgba(255,179,0,.95), rgba(255,179,0,.35)); }
  .strong{ background: linear-gradient(90deg, rgba(77,255,139,.95), rgba(77,255,139,.35)); }

  .strength-text{
    margin-top: 8px;
    color: var(--muted);
    font-size: 13px;
  }

  .row{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top: 16px;
  }

  .btn{
    flex: 1 1 180px;
    padding: 13px 14px;
    border-radius: 14px;
    border:none;
    cursor:pointer;
    font-size: 14px;
    font-weight: 900;
    letter-spacing:.4px;
    transition:.25s;
    text-decoration:none;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    user-select:none;
  }

  .btn.primary{
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    color:#151515;
    box-shadow: 0 10px 24px rgba(255,215,0,.18);
  }
  .btn.primary:hover{
    transform: translateY(-1px);
    box-shadow: 0 14px 34px rgba(255,215,0,.28);
    background: linear-gradient(135deg, #ffe44d, #d4b200);
  }

  .btn.secondary{
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,215,0,.14);
    color:#eee;
  }
  .btn.secondary:hover{
    background: rgba(255,255,255,.06);
    transform: translateY(-1px);
  }
</style>

<div class="wrap">
  <div class="card">
    <div class="top">
      <div>
        <h2>Change Password</h2>
        <p class="sub">Update credentials for the selected user securely.</p>
      </div>
      <span class="pill">User: <b>{{ u.username }}</b> ‚Ä¢ Role: <b>{{ u.role }}</b></span>
    </div>

    {% with messages = get_flashed_messages(with_categories=True) %}
      {% if messages %}
        {% for category, msg in messages %}
          <div class="flash {{ category }}">{{ msg }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" id="pwdForm" autocomplete="off">
      <div class="field">
        <label for="new_password">New password</label>
        <div class="control">
          <input id="new_password" type="password" name="password" required minlength="4" placeholder="Enter new password">
          <div class="icon" onclick="togglePwd('new_password', this)">üëÅÔ∏è</div>
        </div>
      </div>

      <div class="field">
        <label for="confirm_password">Confirm new password</label>
        <div class="control">
          <input id="confirm_password" type="password" name="confirm_password" required minlength="4" placeholder="Confirm new password">
          <div class="icon" onclick="togglePwd('confirm_password', this)">üëÅÔ∏è</div>
        </div>
      </div>

      <div class="strength">
        <div class="strength-bar"><div id="strengthBar"></div></div>
        <div class="strength-text" id="strengthText">Password strength</div>
      </div>

      <div class="row">
        <button class="btn primary" type="submit">Save Password</button>
        <a class="btn secondary" href="{{ url_for('admin_users') }}">‚Üê Back to Users</a>
      </div>
    </form>
  </div>
</div>

<script>
  function togglePwd(id, el){
    const input = document.getElementById(id);
    if(!input) return;
    const isPwd = input.type === "password";
    input.type = isPwd ? "text" : "password";
    if(el) el.textContent = isPwd ? "üôà" : "üëÅÔ∏è";
  }

  function checkStrength(password){
    const bar = document.getElementById("strengthBar");
    const text = document.getElementById("strengthText");
    if(!bar || !text) return;

    let strength = 0;
    if(password.length >= 8) strength++;
    if(/[A-Z]/.test(password)) strength++;
    if(/[0-9]/.test(password)) strength++;
    if(/[^A-Za-z0-9]/.test(password)) strength++;

    bar.className = "";
    bar.style.width = "0%";

    if(strength <= 1){
      bar.style.width = "33%";
      bar.classList.add("weak");
      text.textContent = "Weak password";
    } else if(strength <= 3){
      bar.style.width = "66%";
      bar.classList.add("medium");
      text.textContent = "Medium strength";
    } else {
      bar.style.width = "100%";
      bar.classList.add("strong");
      text.textContent = "Strong password";
    }
  }

  const pwd = document.getElementById("new_password");
  if(pwd){
    pwd.addEventListener("input", () => checkStrength(pwd.value));
  }

  // client-side match check
  const form = document.getElementById("pwdForm");
  if(form){
    form.addEventListener("submit", function(e){
      const p1 = document.getElementById("new_password").value;
      const p2 = document.getElementById("confirm_password").value;
      if(p1 !== p2){
        alert("‚ùå Passwords do not match!");
        e.preventDefault();
      }
    });
  }
</script>
{% endblock %}
