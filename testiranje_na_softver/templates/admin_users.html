{% extends "base.html" %}
{% block title %}Admin Users{% endblock %}

{% block content %}
<style>
  :root{
    --bgA:#070708;
    --bgB:#101012;
    --card: rgba(18,18,20,.66);
    --stroke: rgba(255,215,0,.18);
    --stroke2: rgba(255,255,255,.10);
    --gold:#ffd700;
    --gold2:#c9a200;
    --text:#f2f2f2;
    --muted:#b9b9b9;
    --danger:#ff4d4d;
    --ok:#4dff8b;
    --vio:#bb86fc;
    --cyan:#03dac6;
  }

  body{
    background:
      radial-gradient(1100px 620px at 18% 0%, rgba(255,215,0,.10), transparent 60%),
      radial-gradient(860px 520px at 82% 10%, rgba(187,134,252,.10), transparent 58%),
      radial-gradient(900px 520px at 50% 120%, rgba(3,218,198,.07), transparent 60%),
      radial-gradient(circle at top, #151516, #0b0b0c 55%, #060607);
    color: var(--text);
    font-family: "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    overflow-x:hidden;
  }

  .wrap{
    padding: 70px 14px;
    min-height: calc(100vh - 160px);
    display:flex;
    justify-content:center;
  }

  .shell{
    width: 100%;
    max-width: 1200px;
    display:grid;
    grid-template-columns: 380px 1fr;
    gap: 22px;
    align-items:start;
  }

  /* LEFT PANEL */
  .brand-panel{
    border-radius: 26px;
    background:
      linear-gradient(145deg, rgba(255,215,0,.09), rgba(0,0,0,.0) 35%),
      linear-gradient(145deg, #141416, #0b0b0d);
    border: 1px solid rgba(255,215,0,.16);
    box-shadow: 0 22px 55px rgba(0,0,0,.78);
    padding: 34px;
    position: sticky;
    top: 26px;
    overflow:hidden;
  }
  .brand-panel::before{
    content:"";
    position:absolute;
    inset:-140px -160px auto auto;
    width: 460px; height: 460px;
    background: radial-gradient(circle, rgba(255,215,0,.22), transparent 62%);
    transform: rotate(18deg);
    pointer-events:none;
  }

  .brand-top{ display:flex; gap:14px; align-items:center; }
  .logo-hero{
    width: 78px; height: 78px; border-radius: 18px;
    background: rgba(0,0,0,.25);
    border: 1px solid rgba(255,215,0,.24);
    display:flex; align-items:center; justify-content:center;
    position: relative; overflow:hidden;
  }
  .logo-hero::after{
    content:"";
    position:absolute; inset:-50px;
    background: linear-gradient(120deg, transparent 35%, rgba(255,215,0,.26) 50%, transparent 65%);
    transform: translateX(-60%) rotate(10deg);
    animation: shine 2.8s ease-in-out infinite;
    pointer-events:none;
  }
  @keyframes shine{
    0%{ transform: translateX(-75%) rotate(10deg); opacity:.25; }
    35%{ opacity:.9; }
    100%{ transform: translateX(75%) rotate(10deg); opacity:.22; }
  }
  .logo-hero img{ width: 58px; height:auto; }

  .brand-title h1{
    margin:0;
    font-size: 18px;
    letter-spacing: 1.15px;
    color: var(--gold);
    text-transform: uppercase;
  }
  .brand-title p{
    margin:6px 0 0 0;
    color: var(--muted);
    font-size: 13.5px;
    line-height: 1.45;
  }

  .divider{
    height:1px; margin:16px 0;
    background: linear-gradient(90deg, transparent, rgba(255,215,0,.22), transparent);
  }

  .mini-cards{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
  }
  .mini{
    border-radius: 16px;
    background: rgba(255,255,255,.03);
    border: 1px solid rgba(255,215,0,.10);
    padding: 12px 12px;
  }
  .mini span{ display:block; color: var(--muted); font-size: 12px; }
  .mini b{
    display:block;
    margin-top: 6px;
    font-size: 18px;
    letter-spacing: .2px;
    color:#fff;
  }

  .brand-actions{ margin-top:16px; display:flex; gap:10px; flex-wrap:wrap; }
  .btn{
    padding:10px 14px; border-radius:14px; border:none;
    cursor:pointer; font-size:14px; font-weight:900;
    transition:.25s; text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
    user-select:none;
  }
  .btn.primary{
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    color:#151515;
    box-shadow: 0 10px 24px rgba(255,215,0,.18);
  }
  .btn.primary:hover{ transform: translateY(-1px); box-shadow: 0 14px 34px rgba(255,215,0,.28); }
  .btn.secondary{
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,215,0,.14);
    color:#eee;
  }
  .btn.secondary:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
  .btn.danger{
    background: rgba(255,77,77,.08);
    border:1px solid rgba(255,77,77,.25);
    color:#ffd0d0;
  }
  .btn.danger:hover{ background: rgba(255,77,77,.14); transform: translateY(-1px); }

  /* RIGHT PANEL */
  .card{
    border-radius: 26px;
    background: var(--card);
    border: 1px solid var(--stroke);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 22px 55px rgba(0,0,0,.82);
    padding: 22px 22px 18px;
    position: relative;
    overflow:hidden;
  }
  .card::before{
    content:"";
    position:absolute;
    inset: -120px auto auto -160px;
    width: 360px; height: 360px;
    background: radial-gradient(circle, rgba(255,215,0,.12), transparent 60%);
    pointer-events:none;
  }

  .topbar{
    position: relative;
    display:flex;
    justify-content:space-between;
    gap: 12px;
    align-items:flex-start;
    margin-bottom: 14px;
  }
  .title h2{ margin:0; font-size: 20px; letter-spacing:.6px; color:#fff; }
  .title p{ margin:6px 0 0; color: var(--muted); font-size: 13.5px; }

  .flash{
    padding: 12px;
    margin: 10px 0 0;
    border-radius: 14px;
    font-size: 14px;
    text-align:center;
    border-left: 4px solid transparent;
    background: rgba(255,255,255,.04);
  }
  .flash.success{ border-left-color: var(--ok); color:#d8ffe5; background: rgba(30,95,43,.35); }
  .flash.error{ border-left-color: var(--danger); color:#ffd0d0; background: rgba(59,29,29,.55); }
  .flash.info{ border-left-color: var(--vio); color:#e5d4ff; background: rgba(43,29,59,.55); }

  /* Controls */
  .controls{
    margin-top: 14px;
    display:flex; gap:10px; flex-wrap:wrap;
    background: rgba(0,0,0,.18);
    border: 1px solid rgba(255,215,0,.10);
    padding: 12px;
    border-radius: 18px;
  }
  .ctrl{
    position: relative;
    flex: 1 1 260px;
    min-width: 240px;
  }
  .ctrl input, .ctrl select{
    width: 100%;
    background: rgba(0,0,0,.28);
    border: 1px solid rgba(255,255,255,.10);
    color: #fff;
    padding: 12px 12px 12px 40px;
    border-radius: 14px;
    outline:none;
    transition: .22s;
    font-size: 14px;
  }
  .ctrl input:focus, .ctrl select:focus{
    border-color: rgba(255,215,0,.55);
    box-shadow: 0 0 0 4px rgba(255,215,0,.10);
  }
  .ctrl .ic{
    position:absolute; left: 12px; top: 50%;
    transform: translateY(-50%);
    width: 22px; height: 22px;
    display:flex; align-items:center; justify-content:center;
    color: var(--gold);
    user-select:none;
  }

  /* List cards */
  .list{ margin-top: 14px; display:grid; gap: 12px; }
  .item{
    border-radius: 20px;
    border: 1px solid rgba(255,215,0,.12);
    background: rgba(0,0,0,.18);
    overflow:hidden;
    transition: .18s ease;
  }
  .item:hover{
    transform: translateY(-1px);
    border-color: rgba(255,215,0,.22);
    box-shadow: 0 14px 28px rgba(0,0,0,.55);
  }
  .item-inner{
    padding: 16px;
    display:grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 14px;
    align-items: center;
  }

  .user{
    display:flex; gap: 12px; align-items:center; min-width:0;
  }
  .avatar{
    width: 44px; height: 44px;
    border-radius: 16px;
    border: 1px solid rgba(255,215,0,.18);
    background: linear-gradient(145deg, rgba(255,215,0,.14), rgba(255,255,255,.02));
    display:flex; align-items:center; justify-content:center;
    color: var(--gold);
    font-weight: 1000;
    letter-spacing: .4px;
    flex: 0 0 auto;
  }
  .umeta{ min-width:0; }
  .uname{
    font-weight: 1000;
    color:#fff;
    letter-spacing: .2px;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .usub{
    margin-top: 6px;
    display:flex;
    gap: 10px;
    flex-wrap: wrap;
    color: var(--muted);
    font-size: 13px;
  }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 7px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    letter-spacing: .25px;
    border: 1px solid rgba(255,255,255,.10);
    background: rgba(0,0,0,.20);
    color:#fff;
    white-space:nowrap;
  }
  .badge i{ width:8px; height:8px; border-radius:999px; background: rgba(255,255,255,.35); display:inline-block; }
  .b-admin{ border-color: rgba(77,255,139,.35); background: rgba(30,95,43,.30); color:#c8ffe0; }
  .b-admin i{ background: rgba(77,255,139,.95); }
  .b-user{ border-color: rgba(124,77,255,.35); background: rgba(98,0,234,.20); color:#eadfff; }
  .b-user i{ background: rgba(187,134,252,.95); }
  .b-created{ border-color: rgba(3,218,198,.25); background: rgba(3,218,198,.10); color:#d6fffb; }
  .b-changed{ border-color: rgba(255,215,0,.20); background: rgba(255,215,0,.08); color:#f7f2d3; }
  .b-by{ border-color: rgba(255,255,255,.10); background: rgba(255,255,255,.03); color:#eee; }

  .right{
    display:flex;
    flex-direction: column;
    gap: 10px;
    align-items:flex-end;
  }
  .badges{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }
  .actions{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

  .a-btn{
    border-radius: 14px;
    padding: 10px 12px;
    border: 1px solid rgba(255,215,0,.14);
    background: rgba(255,255,255,.03);
    color:#eee;
    cursor:pointer;
    font-weight: 900;
    transition:.2s;
    text-decoration:none;
    display:inline-flex; align-items:center; gap:8px;
  }
  .a-btn:hover{ background: rgba(255,255,255,.06); transform: translateY(-1px); }
  .a-btn.danger{
    border-color: rgba(255,77,77,.25);
    background: rgba(255,77,77,.08);
    color:#ffd0d0;
  }
  .a-btn.danger:hover{ background: rgba(255,77,77,.14); }

  .empty{
    padding: 22px;
    text-align:center;
    color: var(--muted);
    border-radius: 18px;
    border: 1px solid rgba(255,215,0,.10);
    background: rgba(0,0,0,.18);
    margin-top: 14px;
  }

  @media(max-width: 1100px){
    .shell{ grid-template-columns: 1fr; max-width: 980px; }
    .brand-panel{ position: relative; top:auto; }
    .item-inner{ grid-template-columns: 1fr; align-items: start; }
    .right{ align-items:flex-start; }
    .badges, .actions{ justify-content:flex-start; }
  }
</style>

<div class="wrap">
  <div class="shell">

    <!-- LEFT -->
    <section class="brand-panel">
      <div class="brand-top">
        <div class="logo-hero">
          <img src="{{ url_for('static', filename='images/logo.png') }}" alt="HOTEL BUFF">
        </div>
        <div class="brand-title">
          <h1>HOTEL BUFF</h1>
          <p>Admin Users ‚Ä¢ Premium list view without horizontal scrolling.</p>
        </div>
      </div>

      <div class="divider"></div>

      <div class="mini-cards">
        <div class="mini"><span>Total</span><b>{{ total }}</b></div>
        <div class="mini"><span>Admins</span><b>{{ admins }}</b></div>
        <div class="mini"><span>Users</span><b>{{ normal_users }}</b></div>
        <div class="mini"><span>Filtered</span><b id="statFiltered">0</b></div>
      </div>

      <div class="brand-actions">
        <a class="btn secondary" href="{{ url_for('home') }}">‚Üê Back</a>
        <a class="btn primary" href="{{ url_for('register') }}">+ Add User</a>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="topbar">
        <div class="title">
          <h2>Registered Users</h2>
          <p>–ü—Ä–µ–≥–ª–µ–¥ –Ω–∞ –∫–æ—Ä–∏—Å–Ω–∏—Ü–∏ –≤–æ SQLite —Ç–∞–±–µ–ª–∞—Ç–∞ <b>users</b>.</p>
        </div>
      </div>

      {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
          {% for category, msg in messages %}
            <div class="flash {{ category }}">{{ msg }}</div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- Keep your GET filters (backend already supports q + role) -->
      <form class="controls" method="GET" action="{{ url_for('admin_users') }}">
        <div class="ctrl">
          <div class="ic">üîé</div>
          <input id="qLive" type="text" placeholder="Search username (live)..." value="{{ q|default('') }}">
        </div>

        <div class="ctrl" style="flex:0 0 260px;">
          <div class="ic">üè∑Ô∏è</div>
          <select name="role" id="roleSelect">
            <option value="" {% if not role_filter %}selected{% endif %}>All roles</option>
            <option value="admin" {% if role_filter == 'admin' %}selected{% endif %}>Admin</option>
            <option value="user" {% if role_filter == 'user' %}selected{% endif %}>User</option>
          </select>
        </div>

        <!-- hidden name=q so your backend keeps working -->
        <input type="hidden" name="q" id="qHidden" value="{{ q|default('') }}">

        <button class="btn secondary" type="submit">Apply</button>
        <a class="btn secondary" href="{{ url_for('admin_users') }}">Reset</a>
      </form>

      {% if users and users|length > 0 %}
      <div class="list" id="list">
        {% for u in users %}
        <article class="item row"
                 data-username="{{ u.username|lower }}"
                 data-role="{{ u.role|lower }}">
          <div class="item-inner">

            <div class="user">
              <div class="avatar">{{ u.username[:2]|upper }}</div>

              <div class="umeta">
                <div class="uname">{{ u.username }}</div>

                <div class="usub">
                  {% if u.role == 'admin' %}
                    <span class="badge b-admin"><i></i>ADMIN</span>
                  {% else %}
                    <span class="badge b-user"><i></i>USER</span>
                  {% endif %}
                  <span class="badge b-created"><i></i>{{ u.created_at }}</span>
                </div>
              </div>
            </div>

            <div class="right">
              <div class="badges">
                <span class="badge b-changed"><i></i>{{ u.password_changed_at if u.password_changed_at else 'Pwd not changed' }}</span>
                <span class="badge b-by"><i></i>{{ u.password_changed_by if u.password_changed_by else '-' }}</span>
              </div>

              <div class="actions">
                <a class="a-btn" href="{{ url_for('edit_user', user_id=u.id) }}">‚úèÔ∏è Edit</a>
                <a class="a-btn" href="{{ url_for('admin_change_user_password', user_id=u.id) }}">üîë Change</a>

                {% if u.username != 'admin' %}
                <form method="POST"
                      action="{{ url_for('delete_user', user_id=u.id) }}"
                      onsubmit="return confirm('Are you sure you want to delete this user?');">
                  <button class="a-btn danger" type="submit">üóëÔ∏è Delete</button>
                </form>
                {% endif %}
              </div>
            </div>

          </div>
        </article>
        {% endfor %}
      </div>
      {% else %}
        <div class="empty">–ù–µ–º–∞ –ø—Ä–æ–Ω–∞—ò–¥–µ–Ω–∏ –∫–æ—Ä–∏—Å–Ω–∏—Ü–∏ –∑–∞ –æ–≤–∞ –ø—Ä–µ–±–∞—Ä—É–≤–∞—ö–µ.</div>
      {% endif %}
    </section>

  </div>
</div>

<script>
  // Live search only (UI) + keep backend GET q
  const rows = Array.from(document.querySelectorAll(".row"));
  const qLive = document.getElementById("qLive");
  const qHidden = document.getElementById("qHidden");
  const statFiltered = document.getElementById("statFiltered");

  function applyLive(){
    const term = (qLive?.value || "").trim().toLowerCase();
    if(qHidden) qHidden.value = term;

    let shown = 0;
    rows.forEach(r=>{
      const ok = !term || r.dataset.username.includes(term);
      r.style.display = ok ? "" : "none";
      if(ok) shown++;
    });

    if(statFiltered) statFiltered.textContent = String(shown);
  }

  if(qLive){
    qLive.addEventListener("input", applyLive);
    applyLive();
  }
</script>
{% endblock %}
